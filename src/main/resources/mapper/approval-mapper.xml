<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Approval">
        <!-- 로그인 -->
        <select id="login" resultType="login" parameterType="map">
                SELECT empid, custid, authyn FROM t_login WHERE loginid = '${loginid}' AND passwd = '${passwd}'
        </select>
        <!-- 인증여부 확인 -->
        <select id="authCheck" resultType="login" parameterType="map">
                SELECT authyn FROM t_login WHERE loginid = '${loginid}'
        </select>
        <!-- 비밀번호, 인증확인 여부 설정 -->
        <update id="setAuth" parameterType="map">
                UPDATE t_login SET passwd = '${passwd}', authyn = 'Y' WHERE loginid = '${loginid}' AND RTRIM(authyn) != 'Y';
        </update>
        <!-- 비밀번호 재설정 전 유저 정보 찾기 -->
        <select id="findUser" resultType="Long" parameterType="map">
                SELECT empid FROM t_login WHERE loginid = '${loginid}'
        </select>
        <!-- 비밀번호 재설정 -->
        <update id="resetPw" parameterType="map">
                UPDATE t_login SET passwd = '${passwd}' WHERE loginid = '${loginid}'
        </update>
        <!-- 로그인, 로그아웃 후 디비 지정 -->
        <select id="use" parameterType="String">
                USE ${dbname}
        </select>
        <!-- 로그인 후 고객의 디비 정보 확인 -->
        <select id="customer" resultType="customer" parameterType="Long">
                SELECT custid, manager_nm, telno, db_nm FROM t_customer WHERE custid = '${custid}'
        </select>
        <!-- 현재 로그인한 사람의 정보 조회 -->
        <select id="user" resultType="user" parameterType="map">
                SELECT empid, emp_nm FROM dbo.t_emp WHERE empid = '${empid}'
        </select>
        <!-- 해당 회사의 회원 모두 조회 -->
        <select id="allUser" resultType="user">
                SELECT empid, emp_nm FROM dbo.t_emp WHERE use_yn = 'Y'
        </select>
        <!-- 리스트 페이지 -->
        <select id="list" resultType="map" parameterType="map">
                SELECT d.docid, d.empid, d.title, d.contents, d.contents_text, FORMAT(d.create_date, 'yyyy-MM-dd H:m') as create_date, e.emp_nm, c.name,
                CASE WHEN d.type_cd = '001' THEN '임시저장' WHEN d.type_cd = '002' THEN '진행중' WHEN d.type_cd = '003' THEN '반려' WHEN d.type_cd = '004' THEN '반려보관' ELSE '완료' END as type_cd,
                CASE WHEN d.status_cd = '001' THEN '내부기안' WHEN d.status_cd = '002' THEN '외부발송' WHEN d.status_cd = '003' THEN '접수문서' WHEN d.status_cd = '004' THEN '보고문서' WHEN d.status_cd = '005' THEN '업무일지' WHEN d.status_cd = '006' THEN '연차신청' WHEN d.status_cd = '007' THEN '지출결의' ELSE '선택' END as status_cd,
                (SELECT count(*) as cnt FROM dbo.t_approval_document_chat as c WHERE c.docid = d.docid) as cnt
                FROM dbo.t_approval_document AS d JOIN dbo.t_emp e ON d.empid = e.empid
                JOIN dbo.t_code AS c ON e.dept_cd = c.code
                <if test="title != null and title != ''">
                        JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                </if>
                WHERE c.category = '부서코드' AND isnull(c.id_parent, '') <![CDATA[<>]]> '' AND c.usyn = '1'
                <if test="title != null and title != '' and pid != null and pid gt 0">
                        <if test="title == '공람확인'">
                                AND e.empid = '${pid}'
                        </if>
                        <if test="title == '공람문서'">
                                AND (e.empid = '${pid}' OR p.empid != 0)
                        </if>
                </if>
                <if test="type_cd != null">
                        AND d.type_cd in (${type_cd})
                </if>
                <if test="status_cd != null and status_cd != ''">
                        AND d.status_cd = ${status_cd}
                </if>
                <if test="startDate != null and startDate != '' and new_msg == null">
                        AND d.create_date <![CDATA[>=]]> '${startDate}'
                </if>
                <if test="endDate != null and endDate != '' and new_msg == null">
                        AND d.create_date <![CDATA[<=]]> '${endDate}'
                </if>
                <if test="search != null and search != ''">
                        AND (d.title LIKE '%${search}%')
                </if>
                <if test="empid != null and empid gt 0">
                        AND d.empid <![CDATA[=]]> '${empid}'
                </if>
                <if test="new_msg != null and new_msg != ''">
                        AND (d.create_date <![CDATA[>=]]> DATEADD(DAY,-1, GETDATE()) AND d.create_date <![CDATA[<=]]> GETDATE())
                </if>
                <if test="end_msg != null and end_msg != ''">
                        AND d.type_cd != '005'
                </if>
                order by d.create_date desc
                OFFSET ${page ? page : 0} * 20 ROWS
                FETCH NEXT 20 ROWS ONLY;
        </select>
        <!-- 파라미터 포함 리스트 갯수 -->
        <select id="cnt" resultType="Long" parameterType="map">
                SELECT count(*) as full_cnt
                FROM dbo.t_approval_document AS d JOIN dbo.t_emp e ON d.empid = e.empid
                JOIN dbo.t_code AS c ON e.dept_cd = c.code
                <if test="title != null and title != ''">
                        JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                </if>
                WHERE c.category = '부서코드' AND isnull(c.id_parent, '') <![CDATA[<>]]> '' AND c.usyn = '1'
                <if test="title != null and title != '' and pid != null and pid gt 0">
                        <if test="title == '공람확인'">
                                AND p.empid = '${pid}'
                        </if>
                        <if test="title == '공람문서'">
                                AND (p.empid = '${pid}' OR p.empid != 0)
                        </if>
                </if>
                <if test="type_cd != null">
                        AND d.type_cd in (${type_cd})
                </if>
                <if test="status_cd != null and status_cd != ''">
                        AND d.status_cd = ${status_cd}
                </if>
                <if test="startDate != null and startDate != '' and new_msg == null">
                        AND d.create_date <![CDATA[>=]]> '${startDate}'
                </if>
                <if test="endDate != null and endDate != '' and new_msg == null">
                        AND d.create_date <![CDATA[<=]]> '${endDate}'
                </if>
                <if test="search != null and search != ''">
                        AND (d.title LIKE '%${search}%')
                </if>
                <if test="empid != null and empid gt 0">
                        AND d.empid <![CDATA[=]]> '${empid}'
                </if>
                <if test="new_msg != null and new_msg != ''">
                        AND (d.create_date <![CDATA[>=]]> DATEADD(DAY,-1, GETDATE()) AND d.create_date <![CDATA[<=]]> GETDATE())
                </if>
                <if test="end_msg != null and end_msg != ''">
                        AND d.type_cd != '005'
                </if>
        </select>
        <!-- 파라미터 미포함 갯수(sub_nav용) -->
        <select id="subCnt" parameterType="string" resultType="subCnt">
                SELECT
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd in (${type_cd})) AS 'all',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd in (${type_cd}) AND status_cd = '001') AS 'internal',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd in (${type_cd}) AND status_cd = '002') AS 'external',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd in (${type_cd}) AND status_cd = '003') AS 'apply',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd in (${type_cd}) AND status_cd = '004') AS 'report',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd in (${type_cd}) AND status_cd = '005') AS 'work',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd in (${type_cd}) AND status_cd = '006') AS 'annual',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd in (${type_cd}) AND status_cd = '007') AS 'spend'
                
        </select>
        <!-- 파라미터 미포함 갯수(sub_nav용) 공람문서 & 공람확인 -->
        <select id="publicSubCnt" parameterType="map" resultType="subCnt">
                <if test="title != null and title == '공람확인'">
                        SELECT
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid 
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd})) AS 'all',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '001') AS 'internal',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '002') AS 'external',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '003') AS 'apply',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '004') AS 'report',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '005') AS 'work',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '006') AS 'annual',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '007') AS 'spend'
                </if>
                <if test="title != null and title == '공람문서'">
                        SELECT
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid 
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND p.empid != 0) AS 'all',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '001' AND p.empid != 0) AS 'internal',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '002' AND p.empid != 0) AS 'external',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '003' AND p.empid != 0) AS 'apply',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '004' AND p.empid != 0) AS 'report',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '005' AND p.empid != 0) AS 'work',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '006' AND p.empid != 0) AS 'annual',
                        (SELECT count(*) AS cnt FROM t_approval_document AS d LEFT OUTER JOIN dbo.t_approval_document_public AS p ON p.docid = d.docid
                        JOIN t_emp AS e ON e.coop_cd = p.pub_cd
                        WHERE e.empid = '${empid}' AND d.type_cd in (${type_cd}) AND d.status_cd = '007' AND p.empid != 0) AS 'spend'
                </if>
        </select>
        <!-- 파라미터 미포함 갯수(sub_nav용) 개인서류 -->
        <select id="personalSubCnt" parameterType="string" resultType="subCnt">
                SELECT
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE empid = '${empid}') AS 'all',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd = '001' AND empid = '${empid}') AS 'draft',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd = '002' AND empid = '${empid}') AS 'ongoing',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd = '003' AND empid = '${empid}') AS 'refer',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd = '004' AND empid = '${empid}') AS 'storage',
                (SELECT count(*) AS cnt FROM t_approval_document
                WHERE type_cd = '005' AND empid = '${empid}') AS 'complete'
        </select>
        <!-- 뷰페이지 -->
        <select id="view" resultType="view" parameterType="Long">
                SELECT e.emp_nm, d.docid, d.empid, d.title, d.contents, d.contents_text, d.reference_docid,
                FORMAT(d.create_date, 'yyyy-MM-dd H:m:s') as create_date,
                CONCAT(FORMAT(d.create_date, 'yyyyMM'), '-', d.status_cd, '-', d.docid) as doc_num,
                CASE WHEN d.reference_docid IS NULL or d.reference_docid = 0 THEN '-' ELSE CONCAT(FORMAT(d.create_date, 'yyyyMM'), '-', d.status_cd, '-', d.reference_docid) END as reference_id,
                CASE WHEN d.type_cd = '001' THEN '임시저장' WHEN d.type_cd = '002' THEN '진행중' WHEN d.type_cd = '003' THEN '반려' WHEN d.type_cd = '004' THEN '반려보관' ELSE '완료' END as type_cd,
                CASE WHEN d.status_cd = '001' THEN '내부기안' WHEN d.status_cd = '002' THEN '외부발송' WHEN d.status_cd = '003' THEN '접수문서' WHEN d.status_cd = '004' THEN '보고문서' WHEN d.status_cd = '005' THEN '업무일지' WHEN d.status_cd = '006' THEN '연차신청' WHEN d.status_cd = '007' THEN '지출결의' ELSE '선택' END as status_cd
                FROM dbo.t_approval_document as d
                LEFT OUTER JOIN t_emp as e ON d.empid = e.empid
                WHERE d.docid = ${id}
        </select>
        <!-- 첨부파일 불러오기 -->
        <select id="file" resultType="file" parameterType="Long">
                SELECT docid, file_path, original_file_name FROM t_approval_document_attach WHERE docid = ${docid}
        </select>
        <!-- 뷰페이지 하단 채팅 정보 -->
        <select id="chat" resultType="chat" parameterType="Long">
                SELECT c.chatid, c.docid, c.empid, c.contents, e.emp_nm FROM t_approval_document_chat c JOIN t_emp e ON c.empid = e.empid WHERE docid = ${id} ORDER BY c.create_date ASC
        </select>
        <!-- 채팅 저장 -->
        <insert id="chatSave" parameterType="chatAjax" useGeneratedKeys="true" keyProperty="chatid">
                INSERT INTO t_approval_document_chat values ('${docid}', '${empid}', null, '${chatContents}', getDate());
        </insert>
        <!-- ajax로 채팅 insert한 것 불러오기 -->
        <select id="chatOne" resultType="chatAjax" parameterType="string">
                SELECT c.docid, c.chatid, c.empid, c.contents as chatContents, e.emp_nm FROM t_approval_document_chat c JOIN t_emp e ON c.empid = e.empid WHERE c.chatid = ${chatid}
        </select>
        <!-- 문서 별 결재자 조회 -->
        <select id="approver" resultType="approver" parameterType="Long">
                SELECT c.id, c.name, e.empid, e.emp_nm, c.code FROM t_code AS c
                JOIN t_approval_document_step AS s ON s.pos_cd = c.code
                JOIN t_emp AS e ON c.code = e.pos_cd
                WHERE c.category = '결재직위코드' AND isnull(c.id_parent, '') <![CDATA[<>]]> '' AND c.usyn = '1' AND s.docid = '${docid}'
                ORDER BY c.seq
        </select>
        <!-- 문서 별 공람자 조회 -->
        <select id="viewer" resultType="approver" parameterType="Long">
                SELECT c.id, c.name, e.empid, e.emp_nm, c.code FROM t_code AS c
                JOIN t_approval_document_public AS p ON p.pub_cd = c.code
                JOIN t_emp AS e ON c.code = e.coop_cd
                WHERE c.category = '공람분류' AND isnull(c.id_parent, '') <![CDATA[<>]]> '' AND c.usyn = '1' AND p.docid = '${docid}'
                ORDER BY c.seq
        </select>
        <!-- 문서 별 결재 완료자 -->
        <select id="docApprover" parameterType="Long" resultType="Long">
                SELECT e.empid FROM t_code AS c
                JOIN t_approval_document_step AS s ON s.pos_cd = c.code
                JOIN t_emp AS e ON c.code = e.pos_cd
                WHERE c.category = '결재직위코드' AND isnull(c.id_parent, '') <![CDATA[<>]]> '' AND c.usyn = '1' AND s.docid = '${docid}' AND s.empid != 0
                ORDER BY c.seq
        </select>
        <!-- 문서 별 공람 확인자 -->
        <select id="docViewer" parameterType="Long" resultType="Long">
                SELECT e.empid FROM t_code AS c
                JOIN t_approval_document_public AS p ON p.pub_cd = c.code
                JOIN t_emp AS e ON c.code = e.coop_cd
                WHERE c.category = '공람분류' AND isnull(c.id_parent, '') <![CDATA[<>]]> '' AND c.usyn = '1' AND p.docid = '${docid}' AND p.empid != 0
                ORDER BY c.seq
        </select>
        <!-- 결재체크 -->
        <update id="docCheck" parameterType="map">
                UPDATE t_approval_document_step SET empid = '${empid}', end_date = getDate() WHERE docid = '${docid}' AND pos_cd = '${code}'
        </update>
        <!-- 반려 -->
        <update id="docRefer" parameterType="map">
                UPDATE INTO t_approval_document_step SET empid = '${empid}' WHERE docid = '${docid}' AND pub_cd = '${code}'
        </update>
        <!-- 회수 -->
        <update id="docCollect" parameterType="map">
                UPDATE t_approval_document SET type_cd = "001" WHERE docid = '${docid}'
        </update>
        <!-- 공람체크 -->
        <update id="viewerCheck" parameterType="map">
                UPDATE t_approval_document_public SET empid = '${empid}' WHERE docid = '${docid}' AND pub_cd = '${code}'
        </update>
        <!-- 글 편집 후 저장 -->
        <update id="update" parameterType="map">
                UPDATE t_approval_document
                SET title = '${title}', status_cd = '${status_cd}', contents = '${contents}', reference_docid = '${reference_docid}', contents_text = '${contents_text}'
                WHERE docid = '${id}'
        </update>
        <!-- 파일 데이터 업데이트 -->
        <insert id="fileUpdate" parameterType="map">
                INSERT t_approval_document_attach VALUES ('${id}', '${file_path}', '${fileName}', getDate())
        </insert>
        <!-- 결재자 삭제 -->
        <delete id="deleteApprover" parameterType="map">
                DELETE FROM t_approval_doccument_step WHERE docid = '${id}' AND pos_cd != '${coop_cd}'
        </delete>
        <!-- 공람자 삭제 -->
        <delete id="deleteViewer" parameterType="map">
                DELETE FROM t_approval_doccument_step WHERE docid = '${id}' AND pub_cd != '${pos_cd}'
        </delete>
        <!-- 공람자, 결재자 코드 조회 coop_cd: 결재자, pos_cd: 공람자 -->
        <select id="checkCd" parameterType="map" resultType="map">
                SELECT coop_cd, pos_cd FROM t_emp WHERE empid = '${empid}'
        </select>
        <!-- 결재자가 모두 체크했는지 확인 -->
        <select id="checkAppov" parameterType="map" resultType="Long">
                SELECT COUNT(*) AS cnt FROM t_approval_document_step WHERE docid = '${docid}' AND empid = '0'
        </select>
        <!-- 문서 상태 변경 -->
        <update id="approvalDoc" parameterType="map">
                UPDATE t_approval_document SET type_cd = '${type_cd}' WHERE docid = '${id}'
        </update>
        <!-- 글 삭제 -->
        <delete id="delDoc">
                DELETE FROM t_approval_document WHERE docid = '${id}'
        </delete>
        <delete id="delAttach">
                DELETE FROM t_approval_document_attach WHERE docid = '${id}'
        </delete>
        <delete id="delApproval">
                DELETE FROM t_approval_document_step WHERE docid = '${id}'
        </delete>
        <delete id="delViewer">
                DELETE FROM t_approval_document_public WHERE docid = '${id}'
        </delete>
</mapper>