<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Approval">
        <!-- 로그인 -->
        <select id="login" resultType="login" parameterType="map">
                SELECT empid, custid FROM t_login WHERE loginid = '${loginid}' AND passwd = '${passwd}'
        </select>
        <!-- 비밀번호 재설정 전 유저 정보 찾기 -->
        <select id="findUser" resultType="Long" parameterType="map">
                SELECT empid FROM t_login WHERE loginid = '${loginid}'
        </select>
        <!-- 비밀번호 재설정 -->
        <update id="resetPw" parameterType="map">
                update t_login set passwd = '${passwd}' where loginid = '${loginid}'
        </update>
        <!-- 로그인, 로그아웃 후 디비 지정 -->
        <select id="use" parameterType="String">
                use ${dbname}
        </select>
        <!-- 로그인 후 고객의 디비 정보 확인 -->
        <select id="customer" resultType="customer" parameterType="Long">
                SELECT custid, manager_nm, telno, db_nm FROM t_customer WHERE custid = '${custid}'
        </select>
        <!-- 현재 로그인한 사람의 정보 조회 -->
        <select id="user" resultType="user" parameterType="map">
                SELECT empid, emp_nm FROM dbo.t_emp WHERE empid = '${empid}'
        </select>
        <!-- 해당 회사의 회원 모두 조회 -->
        <select id="allUser" resultType="user">
                SELECT empid, emp_nm FROM dbo.t_emp WHERE use_yn = 'Y'
        </select>
        <!-- 리스트 페이지 -->
        <select id="list" resultType="map" parameterType="map">
                SELECT docid, empid, title, contents, contents_text, create_date
                FROM dbo.t_approval_document WHERE 1=1
                <if test="type_cd != null">
                        AND type_cd in (${type_cd})
                </if>
                <if test="status_cd != null">
                        AND status_cd = '${status_cd}'
                </if>
                <if test="startDate != null">
                        <if test="startDate != ''">
                                AND create_date <![CDATA[>=]]> '${startDate}'
                        </if>
                </if>
                <if test="endDate != null">
                        <if test="endDate != ''">
                                AND create_date <![CDATA[<=]]> '${endDate}'
                        </if>
                </if>
                <if test="search != null">
                        <if test="search != ''">
                                AND (title LIKE '%${search}%' OR contents_text LIKE '%${search}%')
                        </if>
                </if>
                <if test="empid != null">
                        <if test="empid != ''">
                                AND empid <![CDATA[=]]> '${empid}'
                        </if>
                </if>
                order by create_date desc
        </select>
        <!-- 뷰페이지 -->
        <select id="view" resultType="view" parameterType="Long">
                SELECT e.emp_nm, d.docid, d.empid, d.title, d.contents, d.contents_text, d.reference_docid,
                FORMAT(d.create_date, 'yyyy-MM-dd H:m:s') as create_date,
                CONCAT(FORMAT(d.create_date, 'yyyyMM'), '-', d.status_cd, '-', d.docid) as doc_num,
                CONCAT(FORMAT(d.create_date, 'yyyyMM'), '-', d.status_cd, '-', d.reference_docid) as reference_id,
                (CASE d.type_cd  WHEN 001 THEN '임시저장' WHEN 002 THEN '진행중' WHEN 003 THEN '반려' WHEN 004 THEN '반려보관' ELSE '완료' END) as type_cd,
                (CASE d.status_cd  WHEN 001 THEN '내부기안' WHEN 002 THEN '외부발송' WHEN 003 THEN '접수문서' WHEN 004 THEN '보고문서' WHEN 005 THEN '업무일지' WHEN 006 THEN '연차신청' WHEN 007 THEN '지출결의' ELSE '선택' END) as status_cd
                FROM dbo.t_approval_document as d
                LEFT OUTER JOIN t_emp as e ON d.empid = e.empid
                WHERE d.docid = ${id}
        </select>
        <!-- 뷰페이지 하단 채팅 정보 -->
        <select id="chat" resultType="chat" parameterType="Long">
                SELECT c.chatid, c.docid, c.empid, c.contents, e.emp_nm FROM t_approval_document_chat c JOIN t_emp e ON c.empid = e.empid WHERE docid = ${id} ORDER BY c.create_date ASC
        </select>
        <!-- 채팅 저장 -->
        <insert id="chatSave" parameterType="chatAjax" useGeneratedKeys="true" keyProperty="chatid">
                INSERT INTO t_approval_document_chat values ('${docid}', '${empid}', null, '${chatContents}', getDate());
        </insert>
        <!-- ajax로 채팅 insert한 것 불러오기 -->
        <select id="chatOne" resultType="chatAjax" parameterType="string">
                SELECT c.docid, c.chatid, c.empid, c.contents as chatContents, e.emp_nm FROM t_approval_document_chat c JOIN t_emp e ON c.empid = e.empid WHERE c.chatid = ${chatid}
        </select>
</mapper>